#!/usr/bin/env bash

set -euo pipefail

COMMIT_MSG_FILE="$1"
COMMIT_SOURCE="${2-}"
SHA1="${3-}"

# Fill in a commit message when it is empty.
# This runs before the editor opens, so it provides a default
# without blocking interactive flows.

# Allow opting out for a single commit or CI.
if [ "${OPENCODE_COMMIT_MSG_DISABLE:-}" = "1" ]; then
  exit 0
fi

# Skip merge/squash/amend flows; they already have meaningful defaults.
case "$COMMIT_SOURCE" in
  merge|squash|commit)
    exit 0
    ;;
esac

# If there's already a non-comment, non-empty line, do nothing.
if grep -qvE '^[[:space:]]*($|#)' "$COMMIT_MSG_FILE"; then
  exit 0
fi

MODEL="${OPENCODE_COMMIT_MODEL:-opencode/grok-code}"
DIFF_MAX_CHARS="${OPENCODE_COMMIT_DIFF_MAX_CHARS:-8000}"

BRANCH="$(git symbolic-ref --quiet --short HEAD 2>/dev/null || true)"
BRANCH="${BRANCH:-DETACHED}"

STAT="$(git diff --staged --stat 2>/dev/null || true)"
DIFF="$(git diff --staged 2>/dev/null || true)"

DIFF_TRUNCATED="$DIFF"
if [ "${#DIFF_TRUNCATED}" -gt "$DIFF_MAX_CHARS" ]; then
  DIFF_TRUNCATED="${DIFF_TRUNCATED:0:$DIFF_MAX_CHARS}
[diff truncated]"
fi

PROMPT="$(cat <<EOF
Write a git commit message.

Rules:
- Line 1: subject (max 72 chars), imperative mood.
- Then a blank line.
- Then an optional body in Markdown (bullets OK). Keep lines <= 72 chars when possible.
- Output ONLY the commit message. Do not wrap in code fences.

Context:
Branch: $BRANCH

Staged changes (stat):
$STAT

Staged diff:
$DIFF_TRUNCATED

If there are no staged changes, still generate a sensible message.
EOF
)"

MESSAGE=""
if command -v opencode >/dev/null 2>&1; then
  printf " Generating default commit message (model: %s)吒n" "$MODEL" >&2

  # Prevent opencode from running any tools that could mutate the repo
  # (eg. staging additional changes during partial commits).
  OPENCODE_PERMISSION_JSON="${OPENCODE_COMMIT_PERMISSION_JSON:-{\"bash\":\"deny\",\"edit\":\"deny\",\"webfetch\":\"deny\",\"external_directory\":\"deny\"}}"

  MESSAGE="$(OPENCODE_PERMISSION="$OPENCODE_PERMISSION_JSON" opencode run --model "$MODEL" "$PROMPT" 2>/dev/null || true)"
  MESSAGE="$(printf "%s" "$MESSAGE" | tr -d '\r')"
else
  printf " opencode not found; using fallback\n" >&2
fi

SUBJECT="$(printf "%s" "$MESSAGE" | sed -n '1p' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')"

# Fallbacks so we never leave the user with an empty message.
if [ -z "$SUBJECT" ]; then
  printf " Failed to generate message; using fallback\n" >&2

  if git diff --staged --quiet 2>/dev/null; then
    MESSAGE="chore: empty commit"
  else
    MESSAGE="chore: update"
  fi
fi

# Always tag auto-generated messages so they stand out in history.
MESSAGE="${MESSAGE%$'\n'}"$'\n\n'" Generated by $MODEL"

TMPFILE="$(mktemp)"
{
  printf "%s\n\n" "$MESSAGE"
  cat "$COMMIT_MSG_FILE"
} > "$TMPFILE"

mv "$TMPFILE" "$COMMIT_MSG_FILE"
