#!/usr/bin/env bash

set -euo pipefail

COMMIT_MSG_FILE="$1"
COMMIT_SOURCE="${2-}"

# Allow opting out for a single commit or CI.
if [ "${OPENCODE_COMMIT_MSG_DISABLE:-}" = "1" ]; then
  exit 0
fi

# Skip merge/squash/amend flows; they already have meaningful defaults.
case "$COMMIT_SOURCE" in
  merge|squash|commit)
    exit 0
    ;;
esac

# If there's already a non-comment, non-empty line, do nothing.
if grep -qvE '^[[:space:]]*($|#)' "$COMMIT_MSG_FILE"; then
  exit 0
fi

# Only generate if opencode is available.
if ! command -v opencode >/dev/null 2>&1; then
  exit 0
fi

MODEL="${OPENCODE_COMMIT_MODEL:-opencode/grok-code}"

# Write the prompt to a temp file
PROMPT_FILE="$(mktemp)"
cat > "$PROMPT_FILE" <<EOF
Write a git commit message.

ðŸš¨ CRITICAL: DO NOT MAKE ANY TOOL CALLS OR PERFORM ANY GIT OR FILE OPERATIONS
You have been configured with denied permissions for bash/edit/write/webfetch.
ONLY output the commit message text. Do not attempt to use any tools.

Rules:
- Line 1: subject (max 72 chars), imperative mood.
- Then a blank line.
- Then an optional body in Markdown (bullets OK). Keep lines <= 72 chars when possible.
- Output ONLY the commit message. Do not wrap in code fences.

Context:
Branch: $(git symbolic-ref --quiet --short HEAD 2>/dev/null || echo "DETACHED")

Staged changes (stat):
$(git diff --staged --stat 2>/dev/null || true)

Staged diff:
$(git diff --staged 2>/dev/null | head -c 8000 || true)

If there are no staged changes, still generate a sensible message.
EOF

printf "ðŸ¤– Generating default commit message (model: %s)â€¦\n" "$MODEL" >&2

# Run opencode with permissions that deny file/git operations
MESSAGE="$(OPENCODE_PERMISSION='{"bash":"deny","edit":"deny","write":"deny","webfetch":"deny","external_directory":"deny"}' opencode run --model "$MODEL" "$(cat "$PROMPT_FILE")" 2>/dev/null || true)"

rm "$PROMPT_FILE"

# Write the generated message to the commit message file
if [ -n "$MESSAGE" ]; then
  MESSAGE="${MESSAGE%$'\n'}"$'\n\n'"ðŸ¤– Generated by $MODEL"
  ORIGINAL="$(cat "$COMMIT_MSG_FILE")"
  printf "%s\n\n%s" "$MESSAGE" "$ORIGINAL" > "$COMMIT_MSG_FILE"
fi
