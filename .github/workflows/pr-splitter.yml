name: PR Splitter

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to split (e.g., dev/ericclemmons)'
        required: true
        type: string
  pull_request:
    types: [ready_for_review, synchronize]
    branches:
      - main
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

jobs:
  detect-command:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, 'ðŸ”€')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, 'ðŸ”€'))
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
      issues: read
    outputs:
      branch: ${{ steps.detect.outputs.branch }}
      instruction: ${{ steps.detect.outputs.instruction }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect branch and instruction
        id: detect
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          .github/scripts/pr-split-detect-command.sh \
            "${{ github.event_name }}" \
            "${{ github.event.pull_request.number }}" \
            "${{ github.event.issue.number }}" \
            "${{ github.event.comment.body }}"

  split:
    needs: [detect-command]
    if: |
      always() && 
      (github.event_name == 'pull_request' || 
       github.event_name == 'workflow_dispatch' || 
       (needs.detect-command.result == 'success' && needs.detect-command.outputs.branch != ''))
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      actions: read
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine branch and context
        id: context
        run: |
          .github/scripts/pr-split-context.sh \
            "${{ github.event_name }}" \
            "${{ github.ref_name }}" \
            "${{ github.event.inputs.branch }}" \
            "${{ needs.detect-command.outputs.branch }}" \
            "${{ needs.detect-command.outputs.instruction }}" \
            "${{ github.actor }}"

      - name: Setup git branches
        run: .github/scripts/pr-split-setup.sh "${{ steps.context.outputs.user }}"



      - name: Analyze commits
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          .github/scripts/pr-split-analyze.sh \
            "${{ steps.context.outputs.branch }}" \
            "${{ steps.context.outputs.user }}" \
            "${{ steps.context.outputs.mode }}"

      - name: Build prompt with context
        id: build_prompt
        run: |
          # Combine the prompt template with actual commit data
          {
            cat .github/scripts/pr-split-prompt.md
            echo ""
            echo ""
            cat commits-context.json
            echo ""
            echo ""
            echo "Respond with ONLY valid JSON matching the output schema above. No markdown, no explanation outside JSON."
          } > full-prompt.txt
          
          # Set output for next step
          echo "prompt<<EOF" >> $GITHUB_OUTPUT
          cat full-prompt.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "âœ… Built full prompt"

      - name: Call Claude via OAuth
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: ${{ steps.build_prompt.outputs.prompt }}
          show_full_output: true
      
      - name: Save Claude response
        run: |
          # Extract JSON from Claude's execution output file
          # The action outputs the full execution log to a file
          EXECUTION_FILE="${{ steps.claude.outputs.execution_file }}"
          
          if [ -f "$EXECUTION_FILE" ]; then
            # Extract the last assistant message which contains the JSON
            jq -r '.messages[] | select(.role == "assistant") | .content[0].text' "$EXECUTION_FILE" | tail -1 > claude-response-raw.txt
          else
            echo "âŒ Execution file not found: $EXECUTION_FILE"
            exit 1
          fi
          
          # Clean up any markdown code blocks if present
          if grep -q '```json' claude-response-raw.txt; then
            sed -n '/```json/,/```/p' claude-response-raw.txt | sed '1d;$d' > pr-plan.json
          elif grep -q '```' claude-response-raw.txt; then
            sed -n '/```/,/```/p' claude-response-raw.txt | sed '1d;$d' > pr-plan.json
          else
            cp claude-response-raw.txt pr-plan.json
          fi
          
          # Validate JSON
          if ! jq empty pr-plan.json 2>/dev/null; then
            echo "âŒ Claude returned invalid JSON:"
            cat pr-plan.json
            exit 1
          fi
          
          echo "âœ… Claude analysis complete"
          cat pr-plan.json

      - name: Check if diffs required
        run: .github/scripts/pr-split-check-diffs.sh

      - name: Execute PR plan
        env:
          GH_TOKEN: ${{ github.token }}
        run: .github/scripts/pr-split-execute.sh "${{ steps.context.outputs.user }}"

      - name: Update umbrella PR
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          .github/scripts/pr-split-umbrella.sh \
            "${{ steps.context.outputs.branch }}" \
            "${{ steps.context.outputs.user }}"

      - name: Summary
        run: |
          echo "## ðŸŽ‰ PR Splitter Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch analyzed:** \`${{ steps.context.outputs.branch }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f pr-plan.json ]; then
            echo "**PRs created/updated:**" >> $GITHUB_STEP_SUMMARY
            jq -r '.prs[] | "- **\(.title)** (\(.action)) - `\(.branch)`"' pr-plan.json >> $GITHUB_STEP_SUMMARY
          fi
