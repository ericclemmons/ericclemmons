name: PR Splitter

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to split (e.g., dev/ericclemmons)'
        required: true
        type: string
  pull_request:
    types: [ready_for_review, synchronize]
    branches:
      - main
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

jobs:
  detect-command:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, 'ðŸ”€')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, 'ðŸ”€'))
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
      issues: read
    outputs:
      branch: ${{ steps.detect.outputs.branch }}
      instruction: ${{ steps.detect.outputs.instruction }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect branch and instruction
        id: detect
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          .github/scripts/pr-split-detect-command.sh \
            "${{ github.event_name }}" \
            "${{ github.event.pull_request.number }}" \
            "${{ github.event.issue.number }}" \
            "${{ github.event.comment.body }}"

  split:
    needs: [detect-command]
    if: |
      always() && 
      (github.event_name == 'pull_request' || 
       github.event_name == 'workflow_dispatch' || 
       (needs.detect-command.result == 'success' && needs.detect-command.outputs.branch != ''))
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine branch and context
        id: context
        run: |
          .github/scripts/pr-split-context.sh \
            "${{ github.event_name }}" \
            "${{ github.ref_name }}" \
            "${{ github.event.inputs.branch }}" \
            "${{ needs.detect-command.outputs.branch }}" \
            "${{ needs.detect-command.outputs.instruction }}" \
            "${{ github.actor }}"

      - name: Setup git branches
        run: .github/scripts/pr-split-setup.sh "${{ steps.context.outputs.user }}"



      - name: Analyze commits
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          .github/scripts/pr-split-analyze.sh \
            "${{ steps.context.outputs.branch }}" \
            "${{ steps.context.outputs.user }}" \
            "${{ steps.context.outputs.mode }}"

      - name: Call Claude API
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: .github/scripts/pr-split-claude.sh

      - name: Check if diffs required
        run: .github/scripts/pr-split-check-diffs.sh

      - name: Execute PR plan
        env:
          GH_TOKEN: ${{ github.token }}
        run: .github/scripts/pr-split-execute.sh "${{ steps.context.outputs.user }}"

      - name: Update umbrella PR
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          .github/scripts/pr-split-umbrella.sh \
            "${{ steps.context.outputs.branch }}" \
            "${{ steps.context.outputs.user }}"

      - name: Summary
        run: |
          echo "## ðŸŽ‰ PR Splitter Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch analyzed:** \`${{ steps.context.outputs.branch }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f pr-plan.json ]; then
            echo "**PRs created/updated:**" >> $GITHUB_STEP_SUMMARY
            jq -r '.prs[] | "- **\(.title)** (\(.action)) - `\(.branch)`"' pr-plan.json >> $GITHUB_STEP_SUMMARY
          fi
