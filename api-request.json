{
  "model": "claude-3-5-haiku-20241022",
  "max_tokens": 4096,
  "messages": [{
    "role": "user",
    "content": "You are analyzing commits from a developer's branch to automatically split them into logical, self-contained PRs.\n\n## Input Context\n- NEW_COMMITS: Commits not yet in any PR (hash, message, files changed, diff stats)\n- EXISTING_PRS: Open PRs with their commits and files\n- BASE_BRANCH: Usually \"main\"\n\n## Your Goals\n1. Group commits into logical, self-contained PRs that could safely land independently\n2. Each PR should be a complete \"vertical stripe\" - a full feature/fix that doesn't break main\n3. Minimize stacking - only create stacks when there's a clear, necessary dependency\n4. Detect shared file changes across potential PRs and decide the best strategy\n\n## Decision Rules\n\n### Commit Grouping\n- NEW commits can either:\n  - Be added to an EXISTING_PR (if logically related to that PR's purpose)\n  - Create a NEW_PR (if unrelated to existing PRs)\n- Consider commit order - earlier commits might be dependencies for later ones\n- Look for logical cohesion in commit messages and file paths\n\n### Shared File Changes\nWhen multiple commits modify the same file for different purposes:\n- **Extract to parent PR:** If the file change is safe to land alone AND doesn't break main\n  - Example: Adding a new dependency to package.json that both features need\n  - Create PR #0 with just that change, make other PRs depend on it\n- **Duplicate in both PRs:** If the file change breaks main alone BUT is needed for both features\n  - Example: tsconfig.json changes that only make sense with feature code\n  - Apply same change to both PR branches\n- **Ask for clarification:** If you cannot determine safety or independence from commit messages + file paths + stats\n  - Set \"requires_diffs\": true with reasoning\n\n### Stacking Strategy\n- Prefer independent PRs that can land in any order\n- Only create stacks (PR B depends on PR A) when:\n  - PR B's code imports/uses code from PR A\n  - PR B's feature logically requires PR A's feature to exist first\n- Use \"base_branch\" to indicate dependencies:\n  - Independent PR: \"base_branch\": \"main\"\n  - Stacked PR: \"base_branch\": \"pr-split/user/parent-feature\"\n\n## Output Schema\n{\n  \"requires_diffs\": false,\n  \"files_needing_review\": [],\n  \"reasoning\": \"Brief explanation of analysis approach\",\n  \"prs\": [\n    {\n      \"action\": \"create\" | \"update\",\n      \"branch\": \"pr-split/username/descriptive-name\",\n      \"title\": \"Concise PR title (imperative mood, e.g., 'Add user authentication')\",\n      \"commits\": [\"hash1\", \"hash2\"],\n      \"base_branch\": \"main\" | \"pr-split/username/other-branch\",\n      \"depends_on\": [],\n      \"related_to\": [],\n      \"reasoning\": \"Why these commits belong together\"\n    }\n  ]\n}\n\n## Examples\n\n### Example 1: Independent Features\nInput:\n- Commit abc123: \"Add authentication system\" (files: auth.ts, login.tsx)\n- Commit def456: \"Add user profile page\" (files: profile.tsx, api/user.ts)\n- No existing PRs\n\nOutput:\n{\n  \"requires_diffs\": false,\n  \"reasoning\": \"Two unrelated features that can land independently\",\n  \"prs\": [\n    {\n      \"action\": \"create\",\n      \"branch\": \"pr-split/eric/add-authentication-system\",\n      \"title\": \"Add authentication system\",\n      \"commits\": [\"abc123\"],\n      \"base_branch\": \"main\",\n      \"depends_on\": [],\n      \"related_to\": [],\n      \"reasoning\": \"Self-contained auth feature\"\n    },\n    {\n      \"action\": \"create\",\n      \"branch\": \"pr-split/eric/add-user-profile-page\",\n      \"title\": \"Add user profile page\",\n      \"commits\": [\"def456\"],\n      \"base_branch\": \"main\",\n      \"depends_on\": [],\n      \"related_to\": [],\n      \"reasoning\": \"Independent profile feature\"\n    }\n  ]\n}\n\n### Example 2: Clear Dependency (Stack)\nInput:\n- Commit abc123: \"Add auth service\" (files: auth.ts)\n- Commit def456: \"Add login page using auth\" (files: login.tsx)\n- No existing PRs\n\nOutput:\n{\n  \"requires_diffs\": false,\n  \"reasoning\": \"Login page depends on auth service based on commit message\",\n  \"prs\": [\n    {\n      \"action\": \"create\",\n      \"branch\": \"pr-split/eric/add-auth-service\",\n      \"title\": \"Add auth service\",\n      \"commits\": [\"abc123\"],\n      \"base_branch\": \"main\",\n      \"depends_on\": [],\n      \"related_to\": [],\n      \"reasoning\": \"Foundation auth service\"\n    },\n    {\n      \"action\": \"create\",\n      \"branch\": \"pr-split/eric/add-login-page\",\n      \"title\": \"Add login page\",\n      \"commits\": [\"def456\"],\n      \"base_branch\": \"pr-split/eric/add-auth-service\",\n      \"depends_on\": [\"pr-split/eric/add-auth-service\"],\n      \"related_to\": [],\n      \"reasoning\": \"Depends on auth service\"\n    }\n  ]\n}\n\n### Example 3: Shared Config (Extract)\nInput:\n- Commit abc123: \"Add TypeScript strict mode\" (files: tsconfig.json)\n- Commit def456: \"Add auth types\" (files: auth.ts)\n- Commit ghi789: \"Add profile types\" (files: profile.ts)\n- No existing PRs\n\nOutput:\n{\n  \"requires_diffs\": false,\n  \"reasoning\": \"TypeScript config is shared foundation, extract it\",\n  \"prs\": [\n    {\n      \"action\": \"create\",\n      \"branch\": \"pr-split/eric/enable-typescript-strict-mode\",\n      \"title\": \"Enable TypeScript strict mode\",\n      \"commits\": [\"abc123\"],\n      \"base_branch\": \"main\",\n      \"depends_on\": [],\n      \"related_to\": [],\n      \"reasoning\": \"Config foundation for type-safe code\"\n    },\n    {\n      \"action\": \"create\",\n      \"branch\": \"pr-split/eric/add-auth-types\",\n      \"title\": \"Add auth types\",\n      \"commits\": [\"def456\"],\n      \"base_branch\": \"pr-split/eric/enable-typescript-strict-mode\",\n      \"depends_on\": [\"pr-split/eric/enable-typescript-strict-mode\"],\n      \"related_to\": [],\n      \"reasoning\": \"Depends on strict mode config\"\n    },\n    {\n      \"action\": \"create\",\n      \"branch\": \"pr-split/eric/add-profile-types\",\n      \"title\": \"Add profile types\",\n      \"commits\": [\"ghi789\"],\n      \"base_branch\": \"pr-split/eric/enable-typescript-strict-mode\",\n      \"depends_on\": [\"pr-split/eric/enable-typescript-strict-mode\"],\n      \"related_to\": [],\n      \"reasoning\": \"Depends on strict mode config\"\n    }\n  ]\n}\n\n## Now Analyze\n\n{\n  \"base_branch\": \"main\",\n  \"user_branch\": \"dev/ericclemmons\",\n  \"user\": \"ericclemmons\",\n  \"new_commits\": [\n    {\n      \"hash\": \"d3a2e01a4e3e0f7cc06766b27e5db153bd5e793c\",\n      \"subject\": \"Close orphaned PRs: auto-close PRs whose commits no longer exist on branch\\n\",\n      \"body\": \"In incremental mode, now checks if PR commits still exist on dev/username.\\nIf ALL commits from a PR are gone (e.g., after branch reset), closes the PR.\\nThis prevents stale PRs from staying open when their work is no longer relevant.\\n\",\n      \"files\": [{\"path\":\".github/scripts/pr-split-analyze.sh\\n\",\"added\":20,\"deleted\":2}]\n    }\n,\n    {\n      \"hash\": \"ef7f0e14ba314dd9053cdefd6c6cdb043f4f4c8a\",\n      \"subject\": \"Add assignee back: assign PRs to user from branch name (github.actor)\\n\",\n      \"body\": \"When workflow runs, $USER is set to github.actor (e.g., 'ericclemmons')\\nThis is the real GitHub username, not the github-actions bot.\\nPRs will now be assigned to the person who owns the dev/username branch.\\n\",\n      \"files\": [{\"path\":\".github/scripts/pr-split-execute.sh\\n\",\"added\":2,\"deleted\":1}]\n    }\n,\n    {\n      \"hash\": \"eb498c52ca6ec0542d90f9f4aed11a2eff3b3aeb\",\n      \"subject\": \"Refactor workflow: extract inline scripts to separate files\\n\",\n      \"body\": \"- Created pr-split-setup.sh for git configuration\\n- Created pr-split-context.sh for context detection\\n- Created pr-split-claude.sh for Claude API calls\\n- Workflow now passes all params via args (cleaner than inline heredocs)\\n- MODE is properly set and passed: incremental for push/comment, full for workflow_dispatch\\n\",\n      \"files\": [{\"path\":\".github/scripts/pr-split-claude.sh\\n\",\"added\":66,\"deleted\":0},{\"path\":\".github/scripts/pr-split-context.sh\\n\",\"added\":41,\"deleted\":0},{\"path\":\".github/scripts/pr-split-setup.sh\\n\",\"added\":13,\"deleted\":0},{\"path\":\".github/workflows/pr-splitter.yml\\n\",\"added\":12,\"deleted\":95}]\n    }\n,\n    {\n      \"hash\": \"fe08a6d5a03a674612d3979765160a3ead0ed4ab\",\n      \"subject\": \"Simplify umbrella PR format: just show PR numbers (GitHub auto-expands)\\n\",\n      \"body\": \"\\n\",\n      \"files\": [{\"path\":\".github/scripts/pr-split-umbrella.sh\\n\",\"added\":2,\"deleted\":2}]\n    }\n,\n    {\n      \"hash\": \"1342e6e868f2d7a2250997033363100f7d38299f\",\n      \"subject\": \"Show PR hierarchy in umbrella PR: nested numbered lists for stacks\\n\",\n      \"body\": \"\\n\",\n      \"files\": [{\"path\":\".github/scripts/pr-split-umbrella.sh\\n\",\"added\":67,\"deleted\":5}]\n    }\n,\n    {\n      \"hash\": \"22d8d8ba291e4c4a713c9b3ae5901a966af79384\",\n      \"subject\": \"Fix analyze script: fetch branch before analyzing commits\\n\",\n      \"body\": \"\\n\",\n      \"files\": [{\"path\":\".github/scripts/pr-split-analyze.sh\\n\",\"added\":3,\"deleted\":0}]\n    }\n,\n    {\n      \"hash\": \"2eff492f81a364b85f07c417b1b2d18a9d22f890\",\n      \"subject\": \"Fix git branch setup: don't fail if main already exists\\n\",\n      \"body\": \"\\n\",\n      \"files\": [{\"path\":\".github/workflows/pr-splitter.yml\\n\",\"added\":1,\"deleted\":1}]\n    }\n,\n    {\n      \"hash\": \"4dfa287ff5755ce64259f5799d6f637c3a17c06b\",\n      \"subject\": \"Add full vs incremental mode: manual dispatch resets and re-evaluates all PRs\\n\",\n      \"body\": \"\\n\",\n      \"files\": [{\"path\":\".github/scripts/pr-split-analyze.sh\\n\",\"added\":40,\"deleted\":19},{\"path\":\".github/workflows/pr-splitter.yml\\n\",\"added\":7,\"deleted\":1}]\n    }\n,\n    {\n      \"hash\": \"cc750f6b2c20b8b611e05f6e359fccf03a3d9ac3\",\n      \"subject\": \"Add utility functions using lodash\\n\",\n      \"body\": \"These utility functions depend on the lodash package.\\nThis feature should be stacked on top of the lodash dependency PR.\\n\",\n      \"files\": [{\"path\":\"src/lib/utils.ts\\n\",\"added\":18,\"deleted\":0}]\n    }\n,\n    {\n      \"hash\": \"7cd71bc716239c9ffb21a76081785b9475a55dc8\",\n      \"subject\": \"Add lodash dependency for utility functions\\n\",\n      \"body\": \"This shared dependency will be used by future features.\\nIt can safely land on its own without breaking main.\\n\",\n      \"files\": [{\"path\":\"package.json\\n\",\"added\":2,\"deleted\":1}]\n    }\n,\n    {\n      \"hash\": \"fc6f6b5f42705cfb012b3d4c911fce7558edd254\",\n      \"subject\": \"Add Feature B component\\n\",\n      \"body\": \"This is another independent feature that is unrelated to Feature A.\\nIt should be in a separate PR that can land independently.\\n\",\n      \"files\": [{\"path\":\"src/components/FeatureB.astro\\n\",\"added\":15,\"deleted\":0}]\n    }\n,\n    {\n      \"hash\": \"4d42ba5a941a6eea2f160e6e3abd9a25ca27a57d\",\n      \"subject\": \"Add Feature A component\\n\",\n      \"body\": \"This is an independent feature that adds a new reusable component.\\nIt can safely land on main without breaking anything.\\n\",\n      \"files\": [{\"path\":\"src/components/FeatureA.astro\\n\",\"added\":15,\"deleted\":0}]\n    }\n\n  ],\n  \"existing_prs\": [\n    {\n      \"number\": 43,\n      \"title\": \"Add utility functions using lodash\\n\",\n      \"branch\": \"pr-split/ericclemmons/add-utility-functions\\n\",\n      \"base_branch\": \"pr-split/ericclemmons/add-lodash-dependency\\n\",\n      \"commits\": [\"b75016e58d2aa09a2005fd288cc2a7deca2d8303\"],\n      \"files\": [\"src/lib/utils.ts\\n\"]\n    }\n,\n    {\n      \"number\": 42,\n      \"title\": \"Add lodash dependency\\n\",\n      \"branch\": \"pr-split/ericclemmons/add-lodash-dependency\\n\",\n      \"base_branch\": \"main\\n\",\n      \"commits\": [\"c85268dc8b0e72712484393f971d53dc845dd500\"],\n      \"files\": [\"package.json\\n\"]\n    }\n\n  ]\n}\n\nRespond with ONLY valid JSON matching the output schema above. No markdown, no explanation outside JSON.\n"
  }]
}
