{
  "model": "claude-3-5-haiku-20241022",
  "max_tokens": 4096,
  "messages": [{
    "role": "user",
    "content": "You are analyzing commits from a developer's branch to automatically split them into logical, self-contained PRs.\n\n## Input Context\n- NEW_COMMITS: Commits not yet in any PR (hash, message, files changed, diff stats)\n- EXISTING_PRS: Open PRs with their commits and files\n- BASE_BRANCH: Usually \"main\"\n\n## Your Goals\n1. Group commits into logical, self-contained PRs that could safely land independently\n2. Each PR should be a complete \"vertical stripe\" - a full feature/fix that doesn't break main\n3. Minimize stacking - only create stacks when there's a clear, necessary dependency\n4. Detect shared file changes across potential PRs and decide the best strategy\n\n## Decision Rules\n\n### Commit Grouping\n- NEW commits can either:\n  - Be added to an EXISTING_PR (if logically related to that PR's purpose)\n  - Create a NEW_PR (if unrelated to existing PRs)\n- Consider commit order - earlier commits might be dependencies for later ones\n- Look for logical cohesion in commit messages and file paths\n\n### Shared File Changes\nWhen multiple commits modify the same file for different purposes:\n- **Extract to parent PR:** If the file change is safe to land alone AND doesn't break main\n  - Example: Adding a new dependency to package.json that both features need\n  - Create PR #0 with just that change, make other PRs depend on it\n- **Duplicate in both PRs:** If the file change breaks main alone BUT is needed for both features\n  - Example: tsconfig.json changes that only make sense with feature code\n  - Apply same change to both PR branches\n- **Ask for clarification:** If you cannot determine safety or independence from commit messages + file paths + stats\n  - Set \"requires_diffs\": true with reasoning\n\n### Stacking Strategy\n- Prefer independent PRs that can land in any order\n- Only create stacks (PR B depends on PR A) when:\n  - PR B's code imports/uses code from PR A\n  - PR B's feature logically requires PR A's feature to exist first\n- Use \"base_branch\" to indicate dependencies:\n  - Independent PR: \"base_branch\": \"main\"\n  - Stacked PR: \"base_branch\": \"pr-split/user/parent-feature\"\n\n## Output Schema\n{\n  \"requires_diffs\": false,\n  \"files_needing_review\": [],\n  \"reasoning\": \"Brief explanation of analysis approach\",\n  \"prs\": [\n    {\n      \"action\": \"create\" | \"update\",\n      \"branch\": \"pr-split/username/descriptive-name\",\n      \"title\": \"Concise PR title (imperative mood, e.g., 'Add user authentication')\",\n      \"commits\": [\"hash1\", \"hash2\"],\n      \"base_branch\": \"main\" | \"pr-split/username/other-branch\",\n      \"depends_on\": [],\n      \"related_to\": [],\n      \"reasoning\": \"Why these commits belong together\"\n    }\n  ]\n}\n\n## Examples\n\n### Example 1: Independent Features\nInput:\n- Commit abc123: \"Add authentication system\" (files: auth.ts, login.tsx)\n- Commit def456: \"Add user profile page\" (files: profile.tsx, api/user.ts)\n- No existing PRs\n\nOutput:\n{\n  \"requires_diffs\": false,\n  \"reasoning\": \"Two unrelated features that can land independently\",\n  \"prs\": [\n    {\n      \"action\": \"create\",\n      \"branch\": \"pr-split/eric/add-authentication-system\",\n      \"title\": \"Add authentication system\",\n      \"commits\": [\"abc123\"],\n      \"base_branch\": \"main\",\n      \"depends_on\": [],\n      \"related_to\": [],\n      \"reasoning\": \"Self-contained auth feature\"\n    },\n    {\n      \"action\": \"create\",\n      \"branch\": \"pr-split/eric/add-user-profile-page\",\n      \"title\": \"Add user profile page\",\n      \"commits\": [\"def456\"],\n      \"base_branch\": \"main\",\n      \"depends_on\": [],\n      \"related_to\": [],\n      \"reasoning\": \"Independent profile feature\"\n    }\n  ]\n}\n\n### Example 2: Clear Dependency (Stack)\nInput:\n- Commit abc123: \"Add auth service\" (files: auth.ts)\n- Commit def456: \"Add login page using auth\" (files: login.tsx)\n- No existing PRs\n\nOutput:\n{\n  \"requires_diffs\": false,\n  \"reasoning\": \"Login page depends on auth service based on commit message\",\n  \"prs\": [\n    {\n      \"action\": \"create\",\n      \"branch\": \"pr-split/eric/add-auth-service\",\n      \"title\": \"Add auth service\",\n      \"commits\": [\"abc123\"],\n      \"base_branch\": \"main\",\n      \"depends_on\": [],\n      \"related_to\": [],\n      \"reasoning\": \"Foundation auth service\"\n    },\n    {\n      \"action\": \"create\",\n      \"branch\": \"pr-split/eric/add-login-page\",\n      \"title\": \"Add login page\",\n      \"commits\": [\"def456\"],\n      \"base_branch\": \"pr-split/eric/add-auth-service\",\n      \"depends_on\": [\"pr-split/eric/add-auth-service\"],\n      \"related_to\": [],\n      \"reasoning\": \"Depends on auth service\"\n    }\n  ]\n}\n\n### Example 3: Shared Config (Extract)\nInput:\n- Commit abc123: \"Add TypeScript strict mode\" (files: tsconfig.json)\n- Commit def456: \"Add auth types\" (files: auth.ts)\n- Commit ghi789: \"Add profile types\" (files: profile.ts)\n- No existing PRs\n\nOutput:\n{\n  \"requires_diffs\": false,\n  \"reasoning\": \"TypeScript config is shared foundation, extract it\",\n  \"prs\": [\n    {\n      \"action\": \"create\",\n      \"branch\": \"pr-split/eric/enable-typescript-strict-mode\",\n      \"title\": \"Enable TypeScript strict mode\",\n      \"commits\": [\"abc123\"],\n      \"base_branch\": \"main\",\n      \"depends_on\": [],\n      \"related_to\": [],\n      \"reasoning\": \"Config foundation for type-safe code\"\n    },\n    {\n      \"action\": \"create\",\n      \"branch\": \"pr-split/eric/add-auth-types\",\n      \"title\": \"Add auth types\",\n      \"commits\": [\"def456\"],\n      \"base_branch\": \"pr-split/eric/enable-typescript-strict-mode\",\n      \"depends_on\": [\"pr-split/eric/enable-typescript-strict-mode\"],\n      \"related_to\": [],\n      \"reasoning\": \"Depends on strict mode config\"\n    },\n    {\n      \"action\": \"create\",\n      \"branch\": \"pr-split/eric/add-profile-types\",\n      \"title\": \"Add profile types\",\n      \"commits\": [\"ghi789\"],\n      \"base_branch\": \"pr-split/eric/enable-typescript-strict-mode\",\n      \"depends_on\": [\"pr-split/eric/enable-typescript-strict-mode\"],\n      \"related_to\": [],\n      \"reasoning\": \"Depends on strict mode config\"\n    }\n  ]\n}\n\n## Now Analyze\n\n{\n  \"base_branch\": \"main\",\n  \"user_branch\": \"dev/ericclemmons\",\n  \"user\": \"ericclemmons\",\n  \"new_commits\": [\n    {\n      \"hash\": \"8c79394342b68a596c841f5f3a9e049edd7107e0\",\n      \"subject\": \"Fix: umbrella PR query should not filter by author (github-actions creates PRs)\\n\",\n      \"body\": \"\\n\",\n      \"files\": [{\"path\":\".github/scripts/pr-split-umbrella.sh\\n\",\"added\":1,\"deleted\":1}]\n    }\n,\n    {\n      \"hash\": \"c6b74800337b11947fdce65fce1e496d8e2933cf\",\n      \"subject\": \"Add Feature B component\\n\",\n      \"body\": \"This is another independent feature that is unrelated to Feature A.\\nIt should be in a separate PR that can land independently.\\n\",\n      \"files\": [{\"path\":\"src/components/FeatureB.astro\\n\",\"added\":15,\"deleted\":0}]\n    }\n,\n    {\n      \"hash\": \"a7b32ca1ac9f26098066fd402ead50ec327e35f1\",\n      \"subject\": \"Add Feature A component\\n\",\n      \"body\": \"This is an independent feature that adds a new reusable component.\\nIt can safely land on main without breaking anything.\\n\",\n      \"files\": [{\"path\":\"src/components/FeatureA.astro\\n\",\"added\":15,\"deleted\":0}]\n    }\n\n  ],\n  \"existing_prs\": [\n\n  ]\n}\n\nRespond with ONLY valid JSON matching the output schema above. No markdown, no explanation outside JSON.\n"
  }]
}
